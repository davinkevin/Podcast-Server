
variables:
  MAVEN_OPTS: "-Dhttps.protocols=TLSv1.2 -Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=WARN -Dorg.slf4j.simpleLogger.showDateTime=true -Djava.awt.headless=true"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version -DinstallAtEnd=true -DdeployAtEnd=true"
  MAVEN_USER_HOME: $CI_PROJECT_DIR/.m2

.cicd_utils: &cicd_utils |
  function delete_docker_hub_image() {
    COMPONENT=$1
    JWT_TOKEN=$(curl -s -H 'Content-Type: application/json' -d '{"username": "'${DOCKER_IO_USER}'", "password": "'${DOCKER_IO_PASSWORD}'"}' https://hub.docker.com/v2/users/login/ | sed 's@.*token": "\([^"]*\)".*@\1@g')
    curl -L -X DELETE -H "Authorization: JWT $JWT_TOKEN" https://hub.docker.com/v2/repositories/podcastserver/$COMPONENT/tags/$CI_COMMIT_REF_SLUG/
  }

  function kaniko_auth_docker_hub() {
    TOKEN=$(echo -n $DOCKER_IO_USER:$DOCKER_IO_PASSWORD | base64)
    echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"$TOKEN\"}}}" > /kaniko/.docker/config.json
  }

stages:
  - â¬‡ download
  - ğŸ§ª test
  - ğŸ‘·â€ build
  - ğŸ³ packaging
  - ğŸ” Security Analysis

â¬‡ container analysis db:
  stage: â¬‡ download
  image:
    name: aquasec/trivy
    entrypoint: [""]
  script:
    - trivy --download-db-only --no-progress --cache-dir .trivy/
  cache:
    key: trivy-database
    paths:
      - .trivy
  retry: 2

â¬‡ backend:
  stage: â¬‡ download
  image: openjdk:11-slim
  script:
    - ./mvnw $MAVEN_CLI_OPTS -f backend/pom.xml dependency:resolve dependency:resolve-plugins
  cache:
    key:
      files:
        - backend/pom.xml
      prefix: "backend"
    paths:
      - .m2/

â¬‡ ui-v1:
  stage: â¬‡ download
  image: openjdk:8
  script:
    - ./mvnw $MAVEN_CLI_OPTS -f frontend-angularjs/pom.xml frontend:install-node-and-npm frontend:npm@npm-install frontend:jspm@jspm-config frontend:jspm@jspm-install -Djspm_token=$JSPM_GITHUB_AUTH_TOKEN
  cache:
    key:
      files:
        - frontend-angularjs/npm-shrinkwrap.json
        - frontend-angularjs/www/config.js
      prefix: "ui-v1"
    paths:
      - frontend-angularjs/node_modules/
      - frontend-angularjs/www/jspm_packages/
      - frontend-angularjs/target/
      - .m2/

â¬‡ ui-v2:
  stage: â¬‡ download
  image: node:11
  script:
    - yarn --cwd frontend-angular
  cache:
    key:
      files:
        - frontend-angular/yarn.lock
      prefix: "ui-v2"
    paths:
      - .yarn
      - frontend-angular/node_modules/

ğŸ§ª backend:
  stage: ğŸ§ª test
  image: openjdk:11
  needs: [â¬‡ backend]
  services:
    - postgres:12.3-alpine
  variables:
    POSTGRES_USER: test-user
    POSTGRES_PASSWORD: LUiUwCfPwhGx1rQaUJEa7L09mdifP1Es
    POSTGRES_DB: test-db
  script:
    - |
      ./mvnw $MAVEN_CLI_OPTS -f backend/pom.xml \
              liquibase:dropAll \
              liquibase:update \
              jooq-codegen:generate \
              test \
              jacoco:report
    - bash <(curl -s https://codecov.io/bash) -t $CODECOV_TOKEN
  cache:
    key:
      files:
        - backend/pom.xml
      prefix: "backend"
    policy: pull
    paths:
      - .m2/

ğŸ§ª ui-v2:
  stage: ğŸ§ª test
  image: node:11
  needs: [â¬‡ ui-v2]
  script:
    - yarn --cwd frontend-angular test
  cache:
    key:
      files:
        - frontend-angular/yarn.lock
      prefix: "ui-v2"
    policy: pull
    paths:
      - .yarn
      - frontend-angular/node_modules/

ğŸ‘· backend-base-image:
  stage: ğŸ‘·â€ build
  needs: []
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - *cicd_utils
    - kaniko_auth_docker_hub
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/backend/src/main/docker/base-image/Dockerfile --destination podcastserver/backend-base-image:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}

ğŸ‘· backend:
  stage: ğŸ‘·â€ build
  image: openjdk:11-slim
  needs: [ğŸ§ª backend]
  services:
    - postgres:12.3-alpine
  variables:
    POSTGRES_USER: build-user
    POSTGRES_PASSWORD: zSR87g1xj5TyJRZwDpyhPqkLO472QHSf
    POSTGRES_DB: build-db
  script:
    - |
      ./mvnw $MAVEN_CLI_OPTS -f backend/pom.xml \
              liquibase:dropAll \
              liquibase:update \
              jooq-codegen:generate \
              compile
  artifacts:
    paths:
      - backend/target
  cache:
    key:
      files:
        - backend/pom.xml
      prefix: "backend"
    paths:
      - .m2/

ğŸ‘· ui-v1:
  stage: ğŸ‘·â€ build
  image: openjdk:8
  needs: [â¬‡ ui-v1]
  script:
    - ./mvnw $MAVEN_CLI_OPTS -f frontend-angularjs/pom.xml frontend:gulp@build-less frontend:gulp@build-app
  artifacts:
    paths:
      - frontend-angularjs/target/dist/
  cache:
    key:
      files:
        - frontend-angularjs/npm-shrinkwrap.json
        - frontend-angularjs/www/config.js
      prefix: "ui-v1"
    policy: pull
    paths:
      - frontend-angularjs/node_modules/
      - frontend-angularjs/www/jspm_packages/
      - frontend-angularjs/target/

ğŸ‘· ui-v2:
  stage: ğŸ‘·â€ build
  image: node:11
  needs: [â¬‡ ui-v2]
  script:
    - yarn --cwd frontend-angular build
  artifacts:
    paths:
      - frontend-angular/dist/
  cache:
    key:
      files:
        - frontend-angular/yarn.lock
      prefix: "ui-v2"
    policy: pull
    paths:
      - .yarn
      - frontend-angular/node_modules/

ğŸ³ backend:
  stage: ğŸ³ packaging
  image: openjdk:11-slim
  needs: [ğŸ‘· backend, ğŸ‘· backend-base-image]
  script:
    - ./mvnw $MAVEN_CLI_OPTS -f backend/pom.xml jib:build -Dtag=${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG} -Dbase-image-tag=${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
    - if [ "$CI_COMMIT_REF_SLUG" == "master" ]; then ./mvnw $MAVEN_CLI_OPTS -f backend/pom.xml jib:build -Dtag=latest -Dbase-image-tag=${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG} ; fi
  cache:
    key:
      files:
        - backend/pom.xml
      prefix: "backend"
    policy: pull
    paths:
      - .m2/
  environment:
    name: backend/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/backend/tags
    on_stop: ğŸ—‘ backend

ğŸ—‘ backend:
  stage: ğŸ³ packaging
  image: tutum/curl
  dependencies: []
  variables:
    GIT_STRATEGY: none
  before_script:
    - *cicd_utils
  script:
    - delete_docker_hub_image backend
    - delete_docker_hub_image backend-base-image
  rules:
    - if: '$CI_MERGE_REQUEST_ID || $CI_COMMIT_REF_NAME == "master"'
      when: never
    - when: manual
      allow_failure: true
  environment:
    name: backend/$CI_COMMIT_REF_SLUG
    action: stop


ğŸ³ init-db:
  stage: ğŸ³ packaging
  needs: []
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - *cicd_utils
    - kaniko_auth_docker_hub
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/backend/src/main/database/Dockerfile --destination podcastserver/init-db:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
  environment:
    name: init-db/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/init-db/tags
    on_stop: ğŸ—‘ init-db

ğŸ—‘ init-db:
  stage: ğŸ³ packaging
  image: tutum/curl
  dependencies: []
  variables:
    GIT_STRATEGY: none
  before_script:
    - *cicd_utils
  script:
    - delete_docker_hub_image init-db
  rules:
    - if: '$CI_MERGE_REQUEST_ID || $CI_COMMIT_REF_NAME == "master"'
      when: never
    - when: manual
      allow_failure: true
  environment:
    name: init-db/$CI_COMMIT_REF_SLUG
    action: stop

ğŸ³ file-system:
  stage: ğŸ³ packaging
  needs: [â¬‡ backend]
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - *cicd_utils
    - kaniko_auth_docker_hub
  script:
    - sh ./files-system/compile.sh
    - export VERSION="${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}"
    - export PROJECT_DIR=$CI_PROJECT_DIR/files-system/target/docker/
    - /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/file-system:${VERSION}
    - if [ "$VERSION" == "master" ]; then /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/file-system:latest ; fi
  environment:
    name: file-system/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/file-system/tags
    on_stop: ğŸ—‘ file-system

ğŸ—‘ file-system:
  stage: ğŸ³ packaging
  image: tutum/curl
  dependencies: []
  variables:
    GIT_STRATEGY: none
  before_script:
    - *cicd_utils
  script:
    - delete_docker_hub_image file-system
  rules:
    - if: '$CI_MERGE_REQUEST_ID || $CI_COMMIT_REF_NAME == "master"'
      when: never
    - when: manual
      allow_failure: true
  environment:
    name: file-system/$CI_COMMIT_REF_SLUG
    action: stop

ğŸ³ ui:
  stage: ğŸ³ packaging
  needs: [ğŸ‘· ui-v1, ğŸ‘· ui-v2, ğŸ§ª ui-v2]
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - *cicd_utils
    - kaniko_auth_docker_hub
  script:
    - sh ./ui/compile.sh
    - export VERSION="${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}"
    - export PROJECT_DIR=$CI_PROJECT_DIR/ui/target/docker/
    - /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/ui:${VERSION}
    - if [ "$VERSION" == "master" ]; then /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/ui:latest ; fi
  environment:
    name: ui/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/ui/tags
    on_stop: ğŸ—‘ ui

ğŸ—‘ ui:
  stage: ğŸ³ packaging
  image: tutum/curl
  dependencies: []
  variables:
    GIT_STRATEGY: none
  before_script:
    - *cicd_utils
  script:
    - delete_docker_hub_image ui
  rules:
    - if: '$CI_MERGE_REQUEST_ID || $CI_COMMIT_REF_NAME == "master"'
      when: never
    - when: manual
      allow_failure: true
  environment:
    name: ui/$CI_COMMIT_REF_SLUG
    action: stop

ğŸ” backend:
  stage: ğŸ” Security Analysis
  image:
    name: aquasec/trivy
    entrypoint: [""]
  needs: [â¬‡ container analysis db, ğŸ³ backend]
  script:
    - trivy --exit-code 0 --no-progress --cache-dir .trivy/ --format template --template "@/contrib/gitlab.tpl" -o gl-container-scanning-report.json podcastserver/backend:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
    - trivy --exit-code 0 --no-progress --cache-dir .trivy/ podcastserver/backend:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
  cache:
    key: trivy-database
    policy: pull
    paths:
      - .trivy

ğŸ” file-system:
  stage: ğŸ” Security Analysis
  image:
    name: aquasec/trivy
    entrypoint: [""]
  needs: [â¬‡ container analysis db, ğŸ³ file-system]
  script:
    - trivy --exit-code 0 --no-progress --cache-dir .trivy/ --format template --template "@/contrib/gitlab.tpl" -o gl-container-scanning-report.json podcastserver/file-system:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
    - trivy --exit-code 0 --no-progress --cache-dir .trivy/ podcastserver/file-system:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
  cache:
    key: trivy-database
    policy: pull
    paths:
      - .trivy

ğŸ” ui:
  stage: ğŸ” Security Analysis
  image:
    name: aquasec/trivy
    entrypoint: [""]
  needs: [â¬‡ container analysis db, ğŸ³ ui]
  script:
    - trivy --exit-code 0 --no-progress --cache-dir .trivy/ --format template --template "@/contrib/gitlab.tpl" -o gl-container-scanning-report.json podcastserver/ui:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
    - trivy --exit-code 0 --no-progress --cache-dir .trivy/ podcastserver/ui:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
  cache:
    key: trivy-database
    policy: pull
    paths:
      - .trivy
