include:
  - local: .gitlab/ci/container-analysis.yaml
  - local: .gitlab/ci/gradle-build-tool.yaml

workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Duser.name=davin.kevin+gitlab-ci-runner-podcast-server"
  GRADLE_USER_HOME: $CI_PROJECT_DIR/.gradle_home
  YARN_CACHE_FOLDER: $CI_PROJECT_DIR/.yarn
  DEVELOCITY_SERVER: https://develocity.davinkevin.fr

stages:
  - â¬‡ download
  - ğŸ§ª test
  - ğŸ‘·â€ build
  - ğŸ³ packaging
  - ğŸ” Security Analysis

â¬‡ backend:
  stage: â¬‡ download
  extends: [ .only-on-backend-changes ]
  needs: [â¬‡ build-tool]
  image: gradle:jdk21
  script:
    - ./gradlew $GRADLE_OPTS :backend:downloadDependencies :backend-lib-youtubedl:downloadDependencies :backend-lib-database:downloadDependencies
  cache:
    - !reference [ .using-build-tool ]
    - key:
        files:
          - backend/build.gradle.kts
        prefix: "backend"
      paths:
        - .gradle
        - .gradle_home/caches
        - backend/build

â¬‡ ui-v1:
  stage: â¬‡ download
  extends: [ .only-on-frontend-changes ]
  needs: [â¬‡ build-tool]
  image: gradle:jdk21
  before_script:
    - apt update && apt install bzip2
  script:
    - ./gradlew $GRADLE_OPTS :frontend-angularjs:downloadDependencies
  cache:
    - !reference [ .using-build-tool ]
    - key:
        files:
          - frontend-angularjs/npm-shrinkwrap.json
          - frontend-angularjs/www/config.js
        prefix: "ui-v1"
      paths:
        - .gradle
        - .gradle_home/caches
        - frontend-angularjs/.gradle
        - frontend-angularjs/node_modules/
        - frontend-angularjs/www/jspm_packages/
        - frontend-angularjs/target/

â¬‡ ui-v2:
  stage: â¬‡ download
  extends: [ .only-on-frontend-changes ]
  needs: [â¬‡ build-tool]
  image: gradle:jdk21
  script:
    - ./gradlew $GRADLE_OPTS :frontend-angular:downloadDependencies
  cache:
    - !reference [ .using-build-tool ]
    - key:
        files:
          - frontend-angular/yarn.lock
        prefix: "ui-v2"
      paths:
        - .gradle
        - .gradle_home/caches
        - .yarn
        - frontend-angular/.gradle
        - frontend-angular/node_modules/

ğŸ§ª backend:
  stage: ğŸ§ª test
  extends: [ .only-on-backend-changes ]
  image: gradle:jdk21
  needs: [â¬‡ backend]
  services:
    - postgres:17.0-alpine
  variables:
    POSTGRES_USER: pg-user
    POSTGRES_PASSWORD: LUiUwCfPwhGx1rQaUJEa7L09mdifP1Es
    POSTGRES_DB: podcast-server-db
  script:
    - ./gradlew $GRADLE_OPTS backend-lib-database:flywayMigrate :backend:test backend:koverLog backend:koverHtmlReport
  artifacts:
    paths:
      - backend/build/reports/kover/html/**/*
    reports:
      junit: backend/build/test-results/test/TEST-*.xml
  coverage: '/^application line coverage:\s(\d+\.\d+%)/'
  cache:
    - !reference [ .using-build-tool ]
    - key:
        files:
          - backend/build.gradle.kts
        prefix: "backend"
      policy: pull
      paths:
        - .gradle
        - .gradle_home/caches
        - backend/build
  retry: 2

ğŸ§ª database:
  stage: ğŸ§ª test
  extends: [ .only-on-backend-changes ]
  image: gradle:jdk21
  needs: [â¬‡ backend]
  services:
    - postgres:17.0-alpine
  variables:
    POSTGRES_USER: pg-user
    POSTGRES_PASSWORD: LUiUwCfPwhGx1rQaUJEa7L09mdifP1Es
    POSTGRES_DB: podcast-server-db
  script:
    - ./gradlew $GRADLE_OPTS backend-lib-database:generateJooq
    - git diff || true
    - git diff-index --quiet HEAD -- || exit 8
  cache:
    - !reference [ .using-build-tool ]
    - key:
        files:
          - backend/build.gradle.kts
        prefix: "backend"
      policy: pull
      paths:
        - .gradle
        - .gradle_home/caches

ğŸ§ª ui-v2:
  stage: ğŸ§ª test
  extends: [ .only-on-frontend-changes ]
  image: gradle:jdk21
  needs: [â¬‡ ui-v2]
  script:
    - ./gradlew $GRADLE_OPTS :frontend-angular:yarn_test
  cache:
    - !reference [ .using-build-tool ]
    - key:
        files:
          - frontend-angular/yarn.lock
        prefix: "ui-v2"
      policy: pull
      paths:
        - .gradle
        - .gradle_home/caches
        - .yarn
        - frontend-angular/.gradle
        - frontend-angular/node_modules/

ğŸ‘· backend-base-image:
  stage: ğŸ‘·â€ build
  extends: [ .only-on-backend-changes ]
  needs: []
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - !reference [ .cicd_utils ]
    - kaniko_auth_docker_hub
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/backend/src/main/base-image/Dockerfile --destination podcastserver/backend-base-image:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}

ğŸ‘· ui-v1:
  stage: ğŸ‘·â€ build
  extends: [ .only-on-frontend-changes ]
  image: gradle:jdk21
  needs: [â¬‡ ui-v1]
  script:
    - ./gradlew $GRADLE_OPTS :frontend-angularjs:build
  artifacts:
    paths:
      - frontend-angularjs/target/dist/
  cache:
    - !reference [ .using-build-tool ]
    - key:
        files:
          - frontend-angularjs/npm-shrinkwrap.json
          - frontend-angularjs/www/config.js
        prefix: "ui-v1"
      policy: pull
      paths:
        - .gradle
        - .gradle_home/caches
        - frontend-angularjs/.gradle
        - frontend-angularjs/node_modules/
        - frontend-angularjs/www/jspm_packages/
        - frontend-angularjs/target/

ğŸ‘· ui-v2:
  stage: ğŸ‘·â€ build
  extends: [ .only-on-frontend-changes ]
  image: gradle:jdk21
  needs: [â¬‡ ui-v2]
  script:
    - ./gradlew $GRADLE_OPTS :frontend-angular:build
  artifacts:
    paths:
      - frontend-angular/dist/
  cache:
    - !reference [ .using-build-tool ]
    - key:
        files:
          - frontend-angular/yarn.lock
        prefix: "ui-v2"
      policy: pull
      paths:
        - .gradle
        - .gradle_home/caches
        - .yarn
        - frontend-angular/.gradle
        - frontend-angular/node_modules/

ğŸ‘· documentation:
  stage: ğŸ‘·â€ build
  needs: []
  extends: [ .only-on-documentation-changes ]
  image: antora/antora
  script:
    - antora generate documentation/documentation.yml --to-dir documentation/dist
  artifacts:
    paths:
      - documentation/dist/

ğŸ³ backend:
  stage: ğŸ³ packaging
  extends: [ .only-on-backend-changes ]
  image: gradle:jdk21
  needs: [â¬‡ backend, ğŸ‘· backend-base-image]
  services:
    - postgres:17.0-alpine
  variables:
    POSTGRES_USER: pg-user
    POSTGRES_PASSWORD: LUiUwCfPwhGx1rQaUJEa7L09mdifP1Es
    POSTGRES_DB: podcast-server-db
  script:
    - ./gradlew $GRADLE_OPTS :backend:jib
  cache:
    - !reference [ .using-build-tool ]
    - key:
        files:
          - backend/build.gradle.kts
        prefix: "backend"
      policy: pull
      paths:
        - .gradle
        - .gradle_home/caches
        - backend/build
  environment:
    name: backend/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/backend/tags
    on_stop: ğŸ—‘ backend

ğŸ—‘ backend:
  stage: ğŸ³ packaging
  extends: [ .delete-docker-image ]
  variables:
    GIT_STRATEGY: none
  script:
    - delete_docker_hub_image backend
    - delete_docker_hub_image backend-base-image
  rules:
    - !reference [ .not-on-default-branch ]
    - !reference [ .manual_run_if_changes_on_backend_files ]
  environment:
    name: backend/$CI_COMMIT_REF_SLUG
    action: stop

ğŸ³ init-db:
  stage: ğŸ³ packaging
  extends: [ .only-on-backend-changes ]
  needs: []
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - !reference [ .cicd_utils ]
    - kaniko_auth_docker_hub
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/backend-lib-database/src/main/docker/Dockerfile --destination podcastserver/init-db:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
    - if [ "${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}" == "$CI_DEFAULT_BRANCH" ]; then /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/backend-lib-database/src/main/docker/Dockerfile --destination podcastserver/init-db:latest ; fi
  environment:
    name: init-db/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/init-db/tags
    on_stop: ğŸ—‘ init-db

ğŸ—‘ init-db:
  stage: ğŸ³ packaging
  extends: [ .delete-docker-image ]
  variables:
    GIT_STRATEGY: none
    COMPONENT: init-db
  rules:
    - !reference [ .not-on-default-branch ]
    - !reference [ .manual_run_if_changes_on_backend_files ]
  environment:
    name: init-db/$CI_COMMIT_REF_SLUG
    action: stop

ğŸ³ storage:
  stage: ğŸ³ packaging
  extends: [ .only-on-storage-changes ]
  needs: []
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - !reference [ .cicd_utils ]
    - kaniko_auth_docker_hub
  script:
    - export VERSION="${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}"
    - export PROJECT_DIR=$CI_PROJECT_DIR/storage
    - /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/storage:${VERSION}
    - if [ "$VERSION" == "$CI_DEFAULT_BRANCH" ]; then /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/storage:latest ; fi
  environment:
    name: storage/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/storage/tags
    on_stop: ğŸ—‘ storage

ğŸ—‘ storage:
  stage: ğŸ³ packaging
  extends: [ .delete-docker-image ]
  variables:
    GIT_STRATEGY: none
    COMPONENT: storage
  rules:
    - !reference [ .not-on-default-branch ]
    - !reference [ .manual_run_if_changes_on_storage_files ]
  environment:
    name: storage/$CI_COMMIT_REF_SLUG
    action: stop

ğŸ³ ui:
  stage: ğŸ³ packaging
  extends: [ .only-on-frontend-changes ]
  needs: [ğŸ‘· ui-v1, ğŸ‘· ui-v2, ğŸ§ª ui-v2]
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - !reference [ .cicd_utils ]
    - kaniko_auth_docker_hub
  script:
    - sh ./ui/compile.sh
    - export VERSION="${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}"
    - export PROJECT_DIR=$CI_PROJECT_DIR/ui/target/docker/
    - /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/ui:${VERSION}
    - if [ "$VERSION" == "$CI_DEFAULT_BRANCH" ]; then /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/ui:latest ; fi
  environment:
    name: ui/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/ui/tags
    on_stop: ğŸ—‘ ui

ğŸ—‘ ui:
  stage: ğŸ³ packaging
  extends: [ .delete-docker-image ]
  variables:
    COMPONENT: ui
  rules:
    - !reference [ .not-on-default-branch ]
    - !reference [ .manual_run_if_changes_on_frontend_files ]
  environment:
    name: ui/$CI_COMMIT_REF_SLUG
    action: stop