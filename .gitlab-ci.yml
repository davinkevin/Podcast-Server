workflow:
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.caching=true -Duser.name=davin.kevin+gitlab-ci-runner-podcast-server"
  GRADLE_USER_HOME: $CI_PROJECT_DIR/.gradle
  YARN_CACHE_FOLDER: $CI_PROJECT_DIR/.yarn
  GRADLE_ENTERPRISE_SERVER: https://gradle-enterprise.davinkevin.fr


.cicd_utils: &cicd_utils |
  function delete_docker_hub_image() {
    COMPONENT=$1
    JWT_TOKEN=$(curl -s -H 'Content-Type: application/json' -d '{"username": "'${DOCKER_IO_USER}'", "password": "'${DOCKER_IO_PASSWORD}'"}' https://hub.docker.com/v2/users/login/ | sed -e 's@.*token":"\([^"]*\)".*@\1@g')
    curl -L -X DELETE -H "Authorization: JWT $JWT_TOKEN" https://hub.docker.com/v2/repositories/podcastserver/$COMPONENT/tags/$CI_COMMIT_REF_SLUG/
  }

  function kaniko_auth_docker_hub() {
    TOKEN=$(echo -n $DOCKER_IO_USER:$DOCKER_IO_PASSWORD | base64)
    echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"$TOKEN\"}}}" > /kaniko/.docker/config.json
  }

.container-scanning-with-trivy:
  variables:
    TRIVY_TIMEOUT: 10m
  image:
    name: aquasec/trivy
    entrypoint: [""]
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json
  cache:
    key: trivy-database
    policy: pull
    paths:
      - .trivy

.delete-docker-image:
  image: curlimages/curl
  dependencies: []
  variables:
    GIT_STRATEGY: none
  before_script:
    - *cicd_utils
  script:
    - delete_docker_hub_image $COMPONENT

.backend_files:
  - &changes_backend_files
    changes:
    - backend/**/*
    - backend-lib-youtubedl/**/*
    - backend-lib-database/**/*

.storage_files:
  - &changes_storage_files
    changes:
    - storage/**/*

.frontend_files:
  - &changes_frontend_files
    changes:
    - frontend-angular/**/*
    - frontend-angularjs/**/*
    - ui/**/*

.documentation_files:
  - &changes_documentation_files
    changes:
      - documentation/**/*

.not-on-default-branch:
  - &rule-not-on-default-branch
    if: '$CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'
    when: never

.only-on-backend-changes:
  rules:
    - *changes_backend_files

.only-on-storage-changes:
  rules:
    - *changes_storage_files

.only-on-frontend-changes:
  rules:
    - *changes_frontend_files

.only-on-documentation-changes:
  rules:
    - *changes_documentation_files

.only-on-code-change:
  rules:
    - *changes_frontend_files
    - *changes_storage_files
    - *changes_backend_files

stages:
  - ‚¨á download
  - üß™ test
  - üë∑‚Äç build
  - üê≥ packaging
  - üîé Security Analysis

‚¨á container analysis db:
  stage: ‚¨á download
  extends: [ .only-on-code-change ]
  image:
    name: aquasec/trivy
    entrypoint: [""]
  script:
    - trivy --cache-dir .trivy/ image --download-db-only --no-progress
  cache:
    key: trivy-database
    paths:
      - .trivy
  retry: 2

‚¨á backend:
  stage: ‚¨á download
  extends: [ .only-on-backend-changes ]
  image: gradle:jdk17
  script:
    - ./gradlew $GRADLE_OPTS :backend:downloadDependencies :backend-lib-youtubedl:downloadDependencies
  cache:
    key:
      files:
        - backend/build.gradle.kts
      prefix: "backend"
    paths:
      - .gradle/
      - backend/build

‚¨á ui-v1:
  stage: ‚¨á download
  extends: [ .only-on-frontend-changes ]
  image: gradle:jdk17
  before_script:
    - apt update && apt install bzip2
  script:
    - ./gradlew $GRADLE_OPTS :frontend-angularjs:downloadDependencies
  cache:
    key:
      files:
        - frontend-angularjs/npm-shrinkwrap.json
        - frontend-angularjs/www/config.js
      prefix: "ui-v1"
    paths:
      - .gradle
      - frontend-angularjs/.gradle
      - frontend-angularjs/node_modules/
      - frontend-angularjs/www/jspm_packages/
      - frontend-angularjs/target/

‚¨á ui-v2:
  stage: ‚¨á download
  extends: [ .only-on-frontend-changes ]
  image: gradle:jdk17
  script:
    - ./gradlew $GRADLE_OPTS :frontend-angular:downloadDependencies
  cache:
    key:
      files:
        - frontend-angular/yarn.lock
      prefix: "ui-v2"
    paths:
      - .gradle
      - .yarn
      - frontend-angular/.gradle
      - frontend-angular/node_modules/

üß™ backend:
  stage: üß™ test
  extends: [ .only-on-backend-changes ]
  image: gradle:jdk17
  needs: [‚¨á backend]
  services:
    - postgres:15.3-alpine
  variables:
    POSTGRES_USER: pg-user
    POSTGRES_PASSWORD: LUiUwCfPwhGx1rQaUJEa7L09mdifP1Es
    POSTGRES_DB: podcast-server-db
  script:
    - ./gradlew $GRADLE_OPTS backend-lib-database:flywayMigrate :backend:test
    - bash <(curl -s https://codecov.io/bash) -t $CODECOV_TOKEN
  artifacts:
    paths:
      - backend/build/reports/jacoco/test/html/**/*
    reports:
      junit: backend/build/test-results/test/TEST-*.xml
  coverage: '/^Coverage:\s(\d+\.\d+%)/'
  cache:
    key:
      files:
        - backend/build.gradle.kts
      prefix: "backend"
    policy: pull
    paths:
      - .gradle/
      - backend/build
  retry: 2

üß™ database:
  stage: üß™ test
  extends: [ .only-on-backend-changes ]
  image: gradle:jdk17
  needs: [‚¨á backend]
  services:
    - postgres:15.3-alpine
  variables:
    POSTGRES_USER: pg-user
    POSTGRES_PASSWORD: LUiUwCfPwhGx1rQaUJEa7L09mdifP1Es
    POSTGRES_DB: podcast-server-db
  script:
    - ./gradlew $GRADLE_OPTS backend-lib-database:generateJooq
    - git diff || true
    - git diff-index --quiet HEAD -- || exit 8
  cache:
    key:
      files:
        - backend/build.gradle.kts
      prefix: "backend"
    policy: pull
    paths:
      - .gradle/

üß™ ui-v2:
  stage: üß™ test
  extends: [ .only-on-frontend-changes ]
  image: gradle:jdk17
  needs: [‚¨á ui-v2]
  script:
    - ./gradlew $GRADLE_OPTS :frontend-angular:yarn_test
  cache:
    key:
      files:
        - frontend-angular/yarn.lock
      prefix: "ui-v2"
    policy: pull
    paths:
      - .gradle
      - .yarn
      - frontend-angular/.gradle
      - frontend-angular/node_modules/

üë∑ backend-base-image:
  stage: üë∑‚Äç build
  extends: [ .only-on-backend-changes ]
  needs: []
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - *cicd_utils
    - kaniko_auth_docker_hub
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/backend/src/main/base-image/Dockerfile --destination podcastserver/backend-base-image:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}

üë∑ ui-v1:
  stage: üë∑‚Äç build
  extends: [ .only-on-frontend-changes ]
  image: gradle:jdk17
  needs: [‚¨á ui-v1]
  script:
    - ./gradlew $GRADLE_OPTS :frontend-angularjs:build
  artifacts:
    paths:
      - frontend-angularjs/target/dist/
  cache:
    key:
      files:
        - frontend-angularjs/npm-shrinkwrap.json
        - frontend-angularjs/www/config.js
      prefix: "ui-v1"
    policy: pull
    paths:
      - .gradle
      - frontend-angularjs/.gradle
      - frontend-angularjs/node_modules/
      - frontend-angularjs/www/jspm_packages/
      - frontend-angularjs/target/

üë∑ ui-v2:
  stage: üë∑‚Äç build
  extends: [ .only-on-frontend-changes ]
  image: gradle:jdk17
  needs: [‚¨á ui-v2]
  script:
    - ./gradlew $GRADLE_OPTS :frontend-angular:build
  artifacts:
    paths:
      - frontend-angular/dist/
  cache:
    key:
      files:
        - frontend-angular/yarn.lock
      prefix: "ui-v2"
    policy: pull
    paths:
      - .gradle
      - .yarn
      - frontend-angular/.gradle
      - frontend-angular/node_modules/

üë∑ documentation:
  stage: üë∑‚Äç build
  needs: []
  extends: [ .only-on-documentation-changes ]
  image: antora/antora
  script:
    - antora generate documentation/documentation.yml --to-dir documentation/dist
  artifacts:
    paths:
      - documentation/dist/

üê≥ backend:
  stage: üê≥ packaging
  extends: [ .only-on-backend-changes ]
  image: gradle:jdk17
  needs: [üë∑ backend-base-image]
  services:
    - postgres:15.3-alpine
  variables:
    POSTGRES_USER: pg-user
    POSTGRES_PASSWORD: LUiUwCfPwhGx1rQaUJEa7L09mdifP1Es
    POSTGRES_DB: podcast-server-db
  script:
    - ./gradlew $GRADLE_OPTS :backend:jib
  cache:
    key:
      files:
        - backend/build.gradle.kts
      prefix: "backend"
    policy: pull
    paths:
      - .gradle/
      - backend/build
  environment:
    name: backend/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/backend/tags
    on_stop: üóë backend

üóë backend:
  stage: üê≥ packaging
  extends: [ .delete-docker-image ]
  variables:
    GIT_STRATEGY: none
  script:
    - delete_docker_hub_image backend
    - delete_docker_hub_image backend-base-image
  rules:
    - if: '$CI_MERGE_REQUEST_ID || $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH'
      when: never
    - changes:
        - backend/**/*
      when: manual
      allow_failure: true
  environment:
    name: backend/$CI_COMMIT_REF_SLUG
    action: stop

üê≥ init-db:
  stage: üê≥ packaging
  extends: [ .only-on-backend-changes ]
  needs: []
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - *cicd_utils
    - kaniko_auth_docker_hub
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/backend-lib-database/src/main/docker/Dockerfile --destination podcastserver/init-db:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
    - if [ "${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}" == "$CI_DEFAULT_BRANCH" ]; then /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/backend-lib-database/src/main/docker/Dockerfile --destination podcastserver/init-db:latest ; fi
  environment:
    name: init-db/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/init-db/tags
    on_stop: üóë init-db

üóë init-db:
  stage: üê≥ packaging
  extends: [ .delete-docker-image ]
  variables:
    GIT_STRATEGY: none
    COMPONENT: init-db
  rules:
    - *rule-not-on-default-branch
    - <<: *changes_backend_files
      when: manual
      allow_failure: true
  environment:
    name: init-db/$CI_COMMIT_REF_SLUG
    action: stop

üê≥ storage:
  stage: üê≥ packaging
  extends: [ .only-on-storage-changes ]
  needs: []
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - *cicd_utils
    - kaniko_auth_docker_hub
  script:
    - export VERSION="${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}"
    - export PROJECT_DIR=$CI_PROJECT_DIR/storage
    - /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/storage:${VERSION}
    - if [ "$VERSION" == "$CI_DEFAULT_BRANCH" ]; then /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/storage:latest ; fi
  environment:
    name: storage/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/storage/tags
    on_stop: üóë storage

üóë storage:
  stage: üê≥ packaging
  extends: [ .delete-docker-image ]
  variables:
    GIT_STRATEGY: none
    COMPONENT: storage
  rules:
    - *rule-not-on-default-branch
    - <<: *changes_storage_files
      when: manual
      allow_failure: true
  environment:
    name: storage/$CI_COMMIT_REF_SLUG
    action: stop

üê≥ ui:
  stage: üê≥ packaging
  extends: [ .only-on-frontend-changes ]
  needs: [üë∑ ui-v1, üë∑ ui-v2, üß™ ui-v2]
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - *cicd_utils
    - kaniko_auth_docker_hub
  script:
    - sh ./ui/compile.sh
    - export VERSION="${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}"
    - export PROJECT_DIR=$CI_PROJECT_DIR/ui/target/docker/
    - /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/ui:${VERSION}
    - if [ "$VERSION" == "$CI_DEFAULT_BRANCH" ]; then /kaniko/executor --context $PROJECT_DIR --dockerfile $PROJECT_DIR/Dockerfile --destination podcastserver/ui:latest ; fi
  environment:
    name: ui/$CI_COMMIT_REF_SLUG
    url: https://cloud.docker.com/u/podcastserver/repository/docker/podcastserver/ui/tags
    on_stop: üóë ui

üóë ui:
  stage: üê≥ packaging
  extends: [ .delete-docker-image ]
  variables:
    COMPONENT: ui
  rules:
    - *rule-not-on-default-branch
    - <<: *changes_frontend_files
      when: manual
      allow_failure: true
  environment:
    name: ui/$CI_COMMIT_REF_SLUG
    action: stop

üîé backend:
  stage: üîé Security Analysis
  extends: [.container-scanning-with-trivy, .only-on-backend-changes]
  needs: [‚¨á container analysis db, üê≥ backend]
  script:
    - trivy --cache-dir .trivy/ image --format template --template "@/contrib/gitlab.tpl" -o gl-container-scanning-report.json --exit-code 0 --no-progress podcastserver/backend:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
    - trivy --cache-dir .trivy/ image --exit-code 0 --no-progress podcastserver/backend:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}

üîé init-db:
  stage: üîé Security Analysis
  extends: [.container-scanning-with-trivy, .only-on-backend-changes]
  needs: [‚¨á container analysis db, üê≥ init-db]
  script:
    - trivy --cache-dir .trivy/ image --format template --template "@/contrib/gitlab.tpl" -o gl-container-scanning-report.json --exit-code 0 --no-progress podcastserver/init-db:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
    - trivy --cache-dir .trivy/ image --exit-code 0 --no-progress podcastserver/init-db:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}

üîé storage:
  stage: üîé Security Analysis
  extends: [.container-scanning-with-trivy, .only-on-storage-changes]
  needs: [‚¨á container analysis db, üê≥ storage]
  script:
    - trivy --cache-dir .trivy/ image --format template --template "@/contrib/gitlab.tpl" -o gl-container-scanning-report.json --exit-code 0 --no-progress podcastserver/storage:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
    - trivy --cache-dir .trivy/ image --exit-code 0 --no-progress podcastserver/storage:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}

üîé ui:
  stage: üîé Security Analysis
  extends: [.container-scanning-with-trivy, .only-on-frontend-changes]
  needs: [‚¨á container analysis db, üê≥ ui]
  script:
    - trivy --cache-dir .trivy/ image --format template --template "@/contrib/gitlab.tpl" -o gl-container-scanning-report.json --exit-code 0 --no-progress podcastserver/ui:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
    - trivy --cache-dir .trivy/ image --exit-code 0 --no-progress podcastserver/ui:${CI_COMMIT_TAG:-$CI_COMMIT_REF_SLUG}
